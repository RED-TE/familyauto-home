<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>패밀리오토플랜 관리자</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --bg:#fbfbfd; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --brand:#16a34a; --brand2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:14.5px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,"Noto Sans KR",sans-serif}
  .wrap{width:min(1200px,94%);margin:26px auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:12px}
  .toolbar .filters{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.6rem .75rem;font:inherit}
  button{cursor:pointer;font-weight:800}
  .btn{background:var(--brand);color:#fff;border-color:transparent}
  .btn:hover{background:var(--brand2)}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
  .table{overflow:auto;border-top:1px solid var(--line)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:.7rem .8rem;border-bottom:1px solid var(--line);vertical-align:top}
  th{position:sticky;top:0;background:#f8fafc;font-weight:900}
  tbody tr:hover{background:#f9fafb}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;gap:.35rem;align-items:center;border:1px solid var(--line);border-radius:999px;padding:.2rem .55rem;font-size:12px;background:#fff}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .ok{background:var(--brand)}
  .warn{background:var(--warn)}
  .danger{background:var(--danger)}
  /* Status styles (요청 색상 매핑) */
  .st-assigned{background:#ef4444;color:#fff;border-color:transparent}   /* 담당자 배정 = 빨간색 */
  .st-unassigned{background:#ffffff;color:var(--ink);border:1px solid var(--line)} /* 미배정 = 흰색 */
  .st-rejected{background:#9ca3af;color:#fff;border-color:transparent}    /* 부결 = 회색 */

  /* Row backgrounds by status (entire row) */
  tbody tr.row-assigned td{background:#fee2e2 !important;} /* 연분홍 - 담당자 배정 */
  tbody tr.row-unassigned td{background:#ffffff !important;} /* 흰색 - 미배정 */
  tbody tr.row-rejected td{background:#e5e7eb !important;}  /* 연회색 - 부결 */

  /* Hover states for better feedback */
  tbody tr.row-assigned:hover td{background:#fecaca !important;}
  tbody tr.row-unassigned:hover td{background:#f9fafb !important;}
  tbody tr.row-rejected:hover td{background:#d1d5db !important;}
  textarea.memo{width:100%;min-height:48px;resize:vertical}
  .cell-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
  .pager{display:flex;gap:6px}
  .pager button[disabled]{opacity:.4;cursor:not-allowed}
  .right{display:flex;gap:8px;align-items:center}
  .sr-only{position:absolute;left:-10000px}
</style>
</head>
<body>
  <div id="auth" style="display:none">
    <div class="wrap">
      <header><h1>관리자 로그인</h1></header>
      <section class="card" style="padding:16px">
        <div style="display:grid;gap:10px;max-width:380px">
          <input id="email" type="email" placeholder="이메일" autocomplete="username" />
          <input id="password" type="password" placeholder="비밀번호" autocomplete="current-password" />
          <button id="btnSignIn" class="btn">로그인</button>
          <p class="muted" id="authMsg" aria-live="polite"></p>
        </div>
      </section>
    </div>
  </div>
  <div id="app" style="display:none">
<div class="wrap">
  <header>
    <h1>관리자 대시보드</h1>
    <div class="right">
      <span class="badge"><span class="status-dot ok"></span>실시간 연결</span>
      <button id="exportCsv" class="btn-ghost">CSV 내보내기</button>
      <button id="refresh" class="btn-ghost">새로고침</button>
      <button id="signOut" class="btn-ghost">로그아웃</button>
    </div>
  </header>

  <!-- 컨트롤바 -->
  <section class="card">
    <div class="toolbar">
      <div class="filters">
        <input type="search" id="q" placeholder="이름/연락처/브랜드/차종/메모 검색" />
        <select id="brand">
          <option value="">브랜드(전체)</option>
          <option>현대</option><option>기아</option><option>제네시스</option><option>쉐보레</option><option>르노코리아</option><option>KGM</option>
          <option>BMW</option><option>메르세데스-벤츠</option><option>아우디</option><option>볼보</option><option>폭스바겐</option>
          <option>토요타</option><option>렉서스</option><option>포드</option><option>미니</option><option>포르쉐</option>
          <option>혼다</option><option>지프</option><option>랜드로버</option><option>푸조</option>
          <option>테슬라</option><option>링컨</option><option>캐딜락</option><option>마세라티</option><option>BYD</option>
        </select>
        <select id="product">
          <option value="">상품(전체)</option>
          <option>장기렌트</option>
          <option>리스</option>
        </select>
        <input type="date" id="from" />
        <input type="date" id="to" />
      </div>
      <div class="right">
        <label class="muted"><input type="checkbox" id="live" checked /> 실시간</label>
      </div>
      <div class="right">
        <button id="apply" class="btn">필터 적용</button>
      </div>
    </div>

    <div class="table">
      <table id="grid" aria-describedby="gridCaption">
        <caption id="gridCaption" class="sr-only">접수 목록</caption>
        <thead>
          <tr>
            <th style="min-width:120px">접수시각</th>
            <th style="min-width:120px">이름</th>
            <th style="min-width:140px">연락처</th>
            <th style="min-width:110px">브랜드</th>
            <th style="min-width:140px">차종</th>
            <th style="min-width:110px">상품</th>
            <th style="min-width:120px">조건</th>
            <th>요청사항</th>
            <th style="min-width:110px">채널</th>
            <th style="min-width:200px">메모</th>
            <th style="min-width:180px">상태</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="muted" id="count">0건</div>
      <div class="pager">
        <button id="prev" class="btn-ghost" disabled>이전</button>
        <button id="next" class="btn-ghost" disabled>다음</button>
      </div>
    </div>
  </section>
</div><!-- /#app -->

<!-- Firebase (v11) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, orderBy, limit, onSnapshot, startAfter } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

// ===== Firebase 설정 =====
const firebaseConfig = {
  apiKey: "AIzaSyDb-hOB-YOvtGvMZLyUXLz4nmwGaSOMrco",
  authDomain: "familycar-home.firebaseapp.com",
  projectId: "familycar-home",
  storageBucket: "familycar-home.appspot.com",
  messagingSenderId: "69504878653",
  appId: "1:69504878653:web:fca733d65e5fc7c126c254",
  measurementId: "G-YXV83SLSD0"
};

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ===== Auth =====
  const auth = getAuth(app);
  const authView = document.getElementById("auth");
  const appView  = document.getElementById("app");
  const authMsg  = document.getElementById("authMsg");

  onAuthStateChanged(auth, (user)=>{
    if (user) {
      authView.style.display = "none";
      appView.style.display = "";
      // 로그인 후 최초 로드
      loadPage().catch(err=>{
        console.error(err);
        authMsg.textContent = "데이터 로드 오류: " + (err?.message||err);
      });
    } else {
      appView.style.display = "none";
      authView.style.display = "";
    }
  });

  document.getElementById("btnSignIn")?.addEventListener("click", async ()=>{
    authMsg.textContent = "";
    const email = (document.getElementById("email")?.value||"").trim();
    const pw    = (document.getElementById("password")?.value||"").trim();
    try {
      await signInWithEmailAndPassword(auth, email, pw);
    } catch (e){
      console.error(e);
      authMsg.textContent = "로그인 실패: " + (e?.message||e);
    }
  });

  document.getElementById("signOut")?.addEventListener("click", async ()=>{
    try { await signOut(auth); } catch(e){ console.error(e); }
  });

// ====== 상태 ======
  const state = {
    pageSize: 50,
    cursors: { first: null, last: null, stack: [] }, // 간단한 페이징
    unsubscribe: null
  };

  // ====== 유틸 ======
  const $ = (s)=>document.querySelector(s);
  const tbody = $("#grid tbody");
  const $count = $("#count");
  const $prev = $("#prev");
  const $next = $("#next");

let ALL = []; // 메모리에 적재해서 필터/검색/페이지네이션
let page = 1;
let unsubscribe = null;

function fmt(ts){
  try{
    if (!ts) return "";
    if (ts.seconds) return new Date(ts.seconds*1000).toLocaleString("ko-KR");
    const d = new Date(ts); return isNaN(d) ? "" : d.toLocaleString("ko-KR");
  }catch(e){ return ""; }
}
function phoneMask(s){
  const d = (s||"").replace(/\D/g,"");
  if (d.length === 11) return d.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
  if (d.length === 10) return d.replace(/(\d{3})(\d{3,4})(\d{4})/, "$1-$2-$3");
  return s||"";
}

  // ====== 쿼리 빌더 ======
  function buildBaseQuery(){
    // 기본: 최근순
    let q = query(collection(db, "inquiries"), orderBy("createdAt","desc"), limit(state.pageSize));
    return q;
  }

  // 서버 필터 없이 클라이언트 필터/검색(간단/유연)
  function clientFilter(rows){
    const q = $("#q").value.trim().toLowerCase();
    const brand = $("#brand").value.trim();
    const product = $("#product").value.trim();
    const from = $("#from").value ? new Date($("#from").value) : null;
    const to = $("#to").value ? new Date($("#to").value + "T23:59:59") : null;

    return rows.filter(r=>{
      if (brand && r.brand !== brand) return false;
      if (product && r.product !== product) return false;
      if (from && r.createdAt && new Date(r.createdAt.seconds*1000) < from) return false;
      if (to && r.createdAt && new Date(r.createdAt.seconds*1000) > to) return false;

      if (!q) return true;
      const hay = [
        r.name, r.phone, r.brand, r.model, r.product, r.terms, r.message, r.channel
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  // ====== 렌더 ======
  function render(rows){
    const filtered = clientFilter(rows);
    $count.textContent = `${filtered.length}건 (표시 기준)`;
    tbody.innerHTML = filtered.map(r => {
      const st = (r.status || "미배정");
      const stBadgeClass = st==="담당자 배정" ? "st-assigned" : st==="부결" ? "st-rejected" : "st-unassigned";
      const rowClass = st==="담당자 배정" ? "row-assigned" : st==="부결" ? "row-rejected" : "row-unassigned";
      return `
        <tr class="${rowClass}" data-id="${r.id}">
          <td class="mono">${fmt(r.createdAt)}</td>
          <td>${r.name||""}</td>
          <td class="mono">${phoneMask(r.phone||"")}</td>
          <td>${r.brand||""}</td>
          <td>${r.model||""}</td>
          <td>${r.product||""}</td>
          <td>${r.terms||""}</td>
          <td>${(r.message||"").replace(/\n/g,"<br>")}</td>
          <td>${r.channel||""}</td>
          <td>
            <div class="cell-actions">
              <textarea class="memo" data-id="${r.id}" placeholder="메모 작성...">${(r.memo||"")}</textarea>
              <button class="btn-ghost save-memo" data-id="${r.id}">저장</button>
            </div>
          </td>
          <td>
            <div class="cell-actions">
              <span class="badge ${stBadgeClass}" data-id="${r.id}" aria-label="현재 상태">${st}</span>
              <select class="status" data-id="${r.id}">
                <option value="미배정" ${st==="미배정"?"selected":""}>미배정</option>
                <option value="담당자 배정" ${st==="담당자 배정"?"selected":""}>담당자 배정</option>
                <option value="부결" ${st==="부결"?"selected":""}>부결</option>
              </select>
              <button class="btn-ghost apply-status" data-id="${r.id}">변경</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");
  }

  // ====== 페이지 로드 (초기/다시 불러오기) ======
  let currentRows = [];

  async function loadPage(afterDoc=null){
    try{
      if (state.unsubscribe){ state.unsubscribe(); state.unsubscribe = null; }

      let q = buildBaseQuery();
      if (afterDoc){
        q = query(collection(db,"inquiries"), orderBy("createdAt","desc"), startAfter(afterDoc), limit(state.pageSize));
      }

      const snap = await getDocs(q);
      currentRows = snap.docs.map(doc=>{
        const d = doc.data() || {};
        return {
          id: doc.id,
          createdAt: (() => {
            if (d.createdAt) return d.createdAt;
            if (d._createdAt) return d._createdAt;
            if (d.ts) return d.ts;
            // fallback: make a Date from doc.createTime to keep relative order
            try { return { seconds: Math.floor(new Date(doc.createTime.toDate ? doc.createTime.toDate() : new Date(doc.createTime)).getTime()/1000) }; } catch (e) { return null; }
          })(),
          name: d.name || "",
          phone: d.phone || "",
          brand: d.brand || d.carBrand || "",
          model: d.model || d.carType || "",
          product: d.product || "",
          terms: d.terms || "",
          message: d.message || "",
          channel: d.channel || d.source || "",
          status: d.status || "new",
          memo: d.memo || ""
        };
      });

      state.cursors.first = snap.docs[0] || null;
      state.cursors.last  = snap.docs[snap.docs.length-1] || null;
      $prev.disabled = state.cursors.stack.length===0;
      $next.disabled = snap.size < state.pageSize;

      render(currentRows);

      if (document.getElementById("live").checked){
        const liveQ = buildBaseQuery();
        state.unsubscribe = onSnapshot(liveQ, liveSnap=>{
          currentRows = liveSnap.docs.map(doc=>{
            const d = doc.data() || {};
            return {
              id: doc.id,
              createdAt: (() => {
                if (d.createdAt) return d.createdAt;
                if (d._createdAt) return d._createdAt;
                if (d.ts) return d.ts;
                // fallback: make a Date from doc.createTime to keep relative order
                try { return { seconds: Math.floor(new Date(doc.createTime.toDate ? doc.createTime.toDate() : new Date(doc.createTime)).getTime()/1000) }; } catch (e) { return null; }
              })(),
              name: d.name || "",
              phone: d.phone || "",
              brand: d.brand || d.carBrand || "",
              model: d.model || d.carType || "",
              product: d.product || "",
              terms: d.terms || "",
              message: d.message || "",
              channel: d.channel || d.source || "",
              status: d.status || "new",
              memo: d.memo || ""
            };
          });
          render(currentRows);
        }, (err)=>{
          console.error(err);
          alert("실시간 구독 오류: " + (err?.message||err));
        });
      }
    }catch(e){
      console.error(e);
      alert("데이터 불러오기 실패: " + (e?.message||e));
    }
  }

  // ====== 이벤트 ======
  $("#apply").addEventListener("click", ()=>render(currentRows));
  $("#q").addEventListener("input", ()=>render(currentRows));
  $("#brand").addEventListener("change", ()=>render(currentRows));
  $("#product").addEventListener("change", ()=>render(currentRows));
  $("#from").addEventListener("change", ()=>render(currentRows));
  $("#to").addEventListener("change", ()=>render(currentRows));
  $("#live").addEventListener("change", ()=>loadPage()); // 실시간 토글 시 재구독
  $("#refresh").addEventListener("click", ()=>loadPage());

// CSV 내보내기 (top-level, once)
document.getElementById("exportCsv").addEventListener("click", ()=>{
  const rows = [["createdAt","name","phone","brand","model","product","terms","message","channel","status"]];
  const filtered = clientFilter(currentRows);
  filtered.forEach(r=>{
    rows.push([
      fmt(r.createdAt),
      r.name||"",
      r.phone||"",
      r.brand||"",
      r.model||"",
      r.product||"",
      r.terms||"",
      (r.message||"").replace(/\n/g," "),
      r.channel||"",
      r.status||"new"
    ]);
  });
  const csv = rows.map(cols => cols.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = `inquiries_${Date.now()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});

// 행 내부(메모 저장 / 상태 변경) 위임 처리
tbody.addEventListener("click", async (e)=>{
  const t = e.target;
  // 메모 저장
  if (t.classList.contains("save-memo")) {
    const id = t.getAttribute("data-id");
    const row = t.closest("tr");
    const memoEl = row.querySelector(`textarea.memo[data-id="${id}"]`);
    const memoVal = (memoEl?.value || "").trim();
    try{
      await updateDoc(doc(db, "inquiries", id), { memo: memoVal });
      // 로컬 데이터도 갱신
      const item = currentRows.find(x=>x.id===id);
      if (item) item.memo = memoVal;
      render(currentRows);
      alert("메모 저장 완료");
    }catch(err){
      console.error(err);
      alert("메모 저장 실패: " + (err?.message||err));
    }
  }
  // 상태 변경 적용
  if (t.classList.contains("apply-status")) {
    const id = t.getAttribute("data-id");
    const row = t.closest("tr");
    const sel = row.querySelector(`select.status[data-id="${id}"]`);
    const val = sel?.value || "미배정";
    try{
      await updateDoc(doc(db, "inquiries", id), { status: val });
      const item = currentRows.find(x=>x.id===id);
      if (item) item.status = val;
      render(currentRows);
    }catch(err){
      console.error(err);
      alert("상태 변경 실패: " + (err?.message||err));
    }
  }
});
tbody.addEventListener("keydown", (e)=>{
  if ((e.metaKey || e.ctrlKey) && e.key === "Enter") {
    const ta = e.target.closest("textarea.memo");
    if (ta) {
      const id = ta.getAttribute("data-id");
      const btn = ta.closest("tr").querySelector(`button.save-memo[data-id="${id}"]`);
      btn?.click();
    }
  }
});

// 초기 로드는 onAuthStateChanged에서 로그인 후 수행
</script>

</body>
</html>
