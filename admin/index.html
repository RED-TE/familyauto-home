<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>패밀리오토플랜 관리자</title>
<meta name="color-scheme" content="light only" />
<style>
  :root{
    --bg:#fbfbfd; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --brand:#16a34a; --brand2:#22c55e; --warn:#f59e0b; --danger:#ef4444;
    --radius:14px; --shadow:0 10px 28px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font:14.5px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Arial,"Noto Sans KR",sans-serif}
  .wrap{width:min(1200px,94%);margin:26px auto}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{font-size:20px;margin:0}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .toolbar{display:grid;grid-template-columns:1fr auto auto;gap:8px;padding:12px}
  .toolbar .filters{display:flex;gap:8px;flex-wrap:wrap}
  input,select,button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:.6rem .75rem;font:inherit}
  button{cursor:pointer;font-weight:800}
  .btn{background:var(--brand);color:#fff;border-color:transparent}
  .btn:hover{background:var(--brand2)}
  .btn-ghost{background:#fff}
  .btn-danger{background:var(--danger);color:#fff;border-color:transparent}
  .table{overflow:auto;border-top:1px solid var(--line)}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:.7rem .8rem;border-bottom:1px solid var(--line);vertical-align:top}
  th{position:sticky;top:0;background:#f8fafc;font-weight:900}
  tbody tr:hover{background:#f9fafb}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .muted{color:var(--muted)}
  .badge{display:inline-flex;gap:.35rem;align-items:center;border:1px solid var(--line);border-radius:999px;padding:.2rem .55rem;font-size:12px;background:#fff}
  .status-dot{width:8px;height:8px;border-radius:50%}
  .ok{background:var(--brand)}
  .warn{background:var(--warn)}
  .danger{background:var(--danger)}
  .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 12px}
  .pager{display:flex;gap:6px}
  .pager button[disabled]{opacity:.4;cursor:not-allowed}
  .right{display:flex;gap:8px;align-items:center}
  .sr-only{position:absolute;left:-10000px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>관리자 대시보드</h1>
    <div class="right">
      <span class="badge"><span class="status-dot ok"></span>실시간 연결</span>
      <button id="exportCsv" class="btn-ghost">CSV 내보내기</button>
      <button id="refresh" class="btn-ghost">새로고침</button>
    </div>
  </header>

  <!-- 컨트롤바 -->
  <section class="card">
    <div class="toolbar">
      <div class="filters">
        <input type="search" id="q" placeholder="이름/연락처/브랜드/차종/메모 검색" />
        <select id="brand">
          <option value="">브랜드(전체)</option>
          <option>현대</option><option>기아</option><option>제네시스</option><option>쉐보레</option><option>르노코리아</option><option>KGM</option>
          <option>BMW</option><option>메르세데스-벤츠</option><option>아우디</option><option>볼보</option><option>폭스바겐</option>
          <option>토요타</option><option>렉서스</option><option>포드</option><option>미니</option><option>포르쉐</option>
          <option>혼다</option><option>지프</option><option>랜드로버</option><option>푸조</option>
          <option>테슬라</option><option>링컨</option><option>캐딜락</option><option>마세라티</option><option>BYD</option>
        </select>
        <select id="product">
          <option value="">상품(전체)</option>
          <option>장기렌트</option>
          <option>리스</option>
        </select>
        <input type="date" id="from" />
        <input type="date" id="to" />
      </div>
      <div class="right">
        <label class="muted"><input type="checkbox" id="live" checked /> 실시간</label>
      </div>
      <div class="right">
        <button id="apply" class="btn">필터 적용</button>
      </div>
    </div>

    <div class="table">
      <table id="grid" aria-describedby="gridCaption">
        <caption id="gridCaption" class="sr-only">접수 목록</caption>
        <thead>
          <tr>
            <th style="min-width:120px">접수시각</th>
            <th style="min-width:120px">이름</th>
            <th style="min-width:140px">연락처</th>
            <th style="min-width:110px">브랜드</th>
            <th style="min-width:140px">차종</th>
            <th style="min-width:110px">상품</th>
            <th style="min-width:120px">조건</th>
            <th>요청사항</th>
            <th style="min-width:110px">채널</th>
            <th style="min-width:90px">상태</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">
      <div class="muted" id="count">0건</div>
      <div class="pager">
        <button id="prev" class="btn-ghost" disabled>이전</button>
        <button id="next" class="btn-ghost" disabled>다음</button>
      </div>
    </div>
  </section>
</div>

<!-- Firebase (v11) -->
<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
import { getFirestore, collection, doc, getDoc, getDocs, updateDoc, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

// ===== Firebase 설정 =====
const firebaseConfig = {
  apiKey: "AIzaSyBp5RDs87mLocfgPZ-oI_GfQ-Lr8SM4xK0",
  authDomain: "familyauto-71c11.firebaseapp.com",
  projectId: "familyauto-71c11",
  storageBucket: "familyauto-71c11.firebasestorage.app",
  messagingSenderId: "251564150896",
  appId: "1:251564150896:web:9bc80da30329ee9cf0e4b5",
  measurementId: "G-PVBC1NH5TG"
};

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);

  // ====== 상태 ======
  const state = {
    pageSize: 50,
    cursors: { first: null, last: null, stack: [] }, // 간단한 페이징
    unsubscribe: null
  };

  // ====== 유틸 ======
  const $ = (s)=>document.querySelector(s);
  const tbody = $("#grid tbody");
  const $count = $("#count");
  const $prev = $("#prev");
  const $next = $("#next");

let ALL = []; // 메모리에 적재해서 필터/검색/페이지네이션
let page = 1;
let unsubscribe = null;

  // ====== 쿼리 빌더 ======
  function buildBaseQuery(){
    // 기본: 최근순
    let q = query(collection(db, "inquiries"), orderBy("createdAt","desc"), limit(state.pageSize));
    return q;
  }

  // 서버 필터 없이 클라이언트 필터/검색(간단/유연)
  function clientFilter(rows){
    const q = $("#q").value.trim().toLowerCase();
    const brand = $("#brand").value.trim();
    const product = $("#product").value.trim();
    const from = $("#from").value ? new Date($("#from").value) : null;
    const to = $("#to").value ? new Date($("#to").value + "T23:59:59") : null;

    return rows.filter(r=>{
      if (brand && r.brand !== brand) return false;
      if (product && r.product !== product) return false;
      if (from && r.createdAt && new Date(r.createdAt.seconds*1000) < from) return false;
      if (to && r.createdAt && new Date(r.createdAt.seconds*1000) > to) return false;

      if (!q) return true;
      const hay = [
        r.name, r.phone, r.brand, r.model, r.product, r.terms, r.message, r.channel
      ].filter(Boolean).join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  // ====== 렌더 ======
  function render(rows){
    const filtered = clientFilter(rows);
    $count.textContent = `${filtered.length}건 (표시 기준)`;
    tbody.innerHTML = filtered.map(r => {
      const statusBadge = `<span class="badge"><span class="status-dot ${r.status==="done"?"ok":r.status==="hold"?"warn":"danger"}"></span>${r.status||"new"}</span>`;
      return `
        <tr>
          <td class="mono">${fmt(r.createdAt)}</td>
          <td>${r.name||""}</td>
          <td class="mono">${phoneMask(r.phone||"")}</td>
          <td>${r.brand||""}</td>
          <td>${r.model||""}</td>
          <td>${r.product||""}</td>
          <td>${r.terms||""}</td>
          <td>${(r.message||"").replace(/\n/g,"<br>")}</td>
          <td>${r.channel||""}</td>
          <td>${statusBadge}</td>
        </tr>
      `;
    }).join("");
  }

  // ====== 페이지 로드 (초기/다시 불러오기) ======
  let currentRows = [];

  async function loadPage(afterDoc=null){
    // 실시간 모드 해제
    if (state.unsubscribe){ state.unsubscribe(); state.unsubscribe = null; }

    let q = buildBaseQuery();
    if (afterDoc){ // 다음 페이지
      q = query(collection(db,"inquiries"), orderBy("createdAt","desc"), startAfter(afterDoc), limit(state.pageSize));
    }

    const snap = await getDocs(q);
    currentRows = snap.docs.map(doc=>{
      const d = doc.data() || {};
      // 필드 정규화(폼 스키마 변경을 대비해 안전하게)
      return {
        id: doc.id,
        createdAt: d.createdAt || d._createdAt || d.ts || null,
        name: d.name || "",
        phone: d.phone || "",
        brand: d.brand || d.carBrand || "",
        model: d.model || d.carType || "",
        product: d.product || "",
        terms: d.terms || "",
        message: d.message || "",
        channel: d.channel || d.source || "",
        status: d.status || "new"
      };
    });

    // 커서/페이저
    state.cursors.first = snap.docs[0] || null;
    state.cursors.last  = snap.docs[snap.docs.length-1] || null;
    $prev.disabled = state.cursors.stack.length===0;
    $next.disabled = snap.size < state.pageSize;

    render(currentRows);

    // 실시간 모드면 동기화
    if ($("#live").checked){
      const liveQ = buildBaseQuery(); // 첫 페이지 기준 실시간
      state.unsubscribe = onSnapshot(liveQ, liveSnap=>{
        currentRows = liveSnap.docs.map(doc=>{
          const d = doc.data() || {};
          return {
            id: doc.id,
            createdAt: d.createdAt || d._createdAt || d.ts || null,
            name: d.name || "",
            phone: d.phone || "",
            brand: d.brand || d.carBrand || "",
            model: d.model || d.carType || "",
            product: d.product || "",
            terms: d.terms || "",
            message: d.message || "",
            channel: d.channel || d.source || "",
            status: d.status || "new"
          };
        });
        render(currentRows);
      });
    }
  }

  // ====== 이벤트 ======
  $("#apply").addEventListener("click", ()=>render(currentRows));
  $("#q").addEventListener("input", ()=>render(currentRows));
  $("#brand").addEventListener("change", ()=>render(currentRows));
  $("#product").addEventListener("change", ()=>render(currentRows));
  $("#from").addEventListener("change", ()=>render(currentRows));
  $("#to").addEventListener("change", ()=>render(currentRows));
  $("#live").addEventListener("change", ()=>loadPage()); // 실시간 토글 시 재구독
  $("#refresh").addEventListener("click", ()=>loadPage());

// ===== 데이터 로딩/렌더링 =====

document.getElementById('btnRefresh').onclick = () => { page=1; refreshAndLoad(); };
document.getElementById('prev').onclick = () => { if(page>1){ page--; render(); } };
document.getElementById('next').onclick = () => {
  const ps = Number(pageSizeEl.value);
  if (page * ps < ALL.length) { page++; render(); }
};
qEl.oninput = debounce(() => { page=1; render(); }, 300);
statusEl.onchange = () => { page=1; render(); };
pageSizeEl.onchange = () => { page=1; render(); };
dateRangeEl.onchange = () => { page=1; render(); };

async function refreshAndLoad(){
  // 실시간 구독 시작
  startRealtime();
}

function startRealtime(){
  loadingEl.style.display = 'block';
  // 기존 구독 해제
  if (typeof unsubscribe === 'function') { unsubscribe(); unsubscribe = null; }

  const qRef = query(collection(db, 'inquiries'), orderBy('createdAt','desc'), limit(1000));
  unsubscribe = onSnapshot(qRef, (snap) => {
    const raw = snap.docs.map(d => ({ id:d.id, ...d.data() }));

    // 날짜 필터는 렌더 단계에서 처리하므로 원본을 저장
    ALL = raw;

    page = 1;
    render();
    loadingEl.style.display = 'none';
  }, (err) => {
    console.error('[admin] onSnapshot error:', err);
    loadingEl.style.display = 'none';
    alert('실시간 구독 오류: ' + (err.message || err));
  });
}

// (미사용) onSnapshot 실시간 모드로 대체됨
async function fetchInquiries(){
  const baseQ = query(collection(db, 'inquiries'), orderBy('createdAt','desc'), limit(1000));
  const snap = await getDocs(baseQ);
  const list = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  // 날짜 필터(클라이언트)
  const now = new Date();
  let startDate;
  if (dateRangeEl.value === 'today') {
    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else if (dateRangeEl.value === '7d') {
    startDate = new Date(now.getTime() - 7*24*60*60*1000);
  }
  return list.filter(r => {
    if (!startDate) return true; // 전체기간
    const t = toDate(r.createdAt);
    return t ? (t >= startDate) : true;
  });
}

function render(){
  const ps = Number(pageSizeEl.value);
  let rows = [...ALL];

  // 날짜 필터 (클라이언트 측)
  const now = new Date();
  let startDate;
  if (dateRangeEl.value === 'today') {
    startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else if (dateRangeEl.value === '7d') {
    startDate = new Date(now.getTime() - 7*24*60*60*1000);
  }
  if (startDate) {
    rows = rows.filter(r => {
      const t = toDate(r.createdAt);
      return t ? (t >= startDate) : true;
    });
  }

  // 상태 필터 (툴바 선택값과 동일한 경우만 필터)
  if (statusEl.value !== 'all') rows = rows.filter(r => r.status === statusEl.value);

  // 텍스트 검색 (이름/전화/브랜드/상품/모델/조건/메시지)
  const s = qEl.value.trim().toLowerCase();
  if (s) {
    rows = rows.filter(r => [r.name, r.phone, r.brand, r.product, r.model, r.terms, r.message]
      .some(v => (v||'').toString().toLowerCase().includes(s)));
  }

  // createdAt desc 정렬
  rows.sort((a,b)=> {
    const da = toDate(a.createdAt) || new Date(0);
    const db = toDate(b.createdAt) || new Date(0);
    return db - da;
  });

  // CSV 내보내기
  $("#exportCsv").addEventListener("click", ()=>{
    const rows = [["createdAt","name","phone","brand","model","product","terms","message","channel","status"]];
    clientFilter(currentRows).forEach(r=>{
      rows.push([
        fmt(r.createdAt),
        r.name||"",
        r.phone||"",
        r.brand||"",
        r.model||"",
        r.product||"",
        r.terms||"",
        (r.message||"").replace(/\n/g," "),
        r.channel||"",
        r.status||"new"
      ]);
    });
    const csv = rows.map(cols => cols.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `inquiries_${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // 초기 로드
  loadPage();
</script>

</body>
</html>
